name: vipdev<%= siteSlug %>
env_file:
  - .env
proxy:
  nginx:
    - <%= siteSlug %>.vipdev.lndo.site
<% if ( multisite ) { %>
    - '*.<%= siteSlug %>.vipdev.lndo.site'
<% } %>
services:

  devtools:
    type: compose
    services:
      image: wpvipdev/dev-tools:0.4
      command: sleep infinity
      volumes:
        - devtools:/dev-tools
    volumes:
      devtools: {}

  nginx:
    type: compose
    services:
      image: wpvipdev/nginx:1.19.2-2
      command: nginx -g "daemon off;"
      volumes:
<% wpVolumes() %>

  php:
    type: compose
    services:
      image: wpvipdev/php-fpm:<%= phpVersion %>
      command: php-fpm
      working_dir: /wp
      volumes:
        - type: volume
          source: devtools
          target: /dev-tools
          volume:
            nocopy: true
<% wpVolumes() %>

    run_as_root:
      - sh /dev-tools/setup.sh database root "http://<%= siteSlug %>.vipdev.lndo.site/" "<%= wpTitle %>" <% if ( multisite ) { %> <%= siteSlug %>.vipdev.lndo.site <% } %>

  database:
    type: mariadb
    #portforward: 13306

  memcached:
    type: memcached:1.5.12

  #mailhog:
  #  type: mailhog
  #  hogfrom:
  #  - php

  phpmyadmin:
    type: phpmyadmin
    hosts:
      - database

  vip-search:
    type: elasticsearch:custom
    portforward: true
    overrides:
      image: bitnami/elasticsearch:7.8.0

  statsd:
    type: compose
    services:
      image: wpvipdev/statsd:v0.8.6-1
      command: node stats.js /config/statsd-config.js

  # Code containers

<% if ( wordpress.mode == 'image' ) { %>
  wordpress:
    type: compose
    services:
      image: <%= wordpress.image %>:<%= wordpress.tag %>
      command: sh -c "rsync -a /wp/ /shared/; sleep infinity"
      volumes:
        - wordpress:/shared
    volumes:
      wordpress: {}
<% } %>

<% if ( muPlugins.mode == 'image' ) { %>
  mu-plugins:
    type: compose
    services:
      image: <%= muPlugins.image %>:<%= muPlugins.tag %>
      command: sh -c 'rsync -a /mu-plugins/ /shared/; sh /autoupdate.sh /shared'
      volumes:
        - mu-plugins:/shared
    volumes:
      mu-plugins: {}
<% } %>

<% if ( jetpack.mode == 'image' ) { %>
  jetpack:
    type: compose
    services:
      image: <%= jetpack.image %>:<%= jetpack.tag %>
      command: sh /run.sh
      volumes:
        - jetpack:/shared
    volumes:
      jetpack: {}
<% } %>

<% if ( clientCode.mode == 'image' ) { %>
  client-code:
    type: compose
    services:
      image: <%= clientCode.image %>:<%= clientCode.tag %>
      command: sleep infinity
      volumes:
        - clientcode_clientmuPlugins:/clientcode/client-mu-plugins
        - clientcode_images:/clientcode/images
        - clientcode_languages:/clientcode/languages
        - clientcode_plugins:/clientcode/plugins
        - clientcode_private:/clientcode/private
        - clientcode_themes:/clientcode/themes
        - clientcode_vipconfig:/clientcode/vip-config
    volumes:
      clientcode_clientmuPlugins: {}
      clientcode_images: {}
      clientcode_languages: {}
      clientcode_plugins: {}
      clientcode_private: {}
      clientcode_themes: {}
      clientcode_vipconfig: {}
<% } %>

tooling:
  wp:
    service: php
    description: "Run WP-CLI command"
    cmd:
      - wp

  test:
    service: php
    description: "Run all tests: lando test"
    cmd:
      - cd /wp/wp-content/mu-plugins && phpunit

  add-fake-data:
    service: php
    description: "Add fake data described in '/configs/fixtures/test_fixtures.yml'. You can also use 'wp fixtures' directly to aim it at other files within lando."
    cmd:
     - wp fixtures load --file=/app/configs/fixtures/test_fixtures.yml

  delete-fake-data:
    service: php
    description: "Delete all fake data generated by 'wp fixtures'"
    cmd:
     - wp fixtures delete

  add-site:
    service: php
    description: "Add site to a multisite installation"
    cmd:
      - bash /dev-tools/add-site.sh

  db:
    service: php
    description: "Connect to the DB using mysql client (e.g. allow to run imports)"
    cmd:
      - mysql -hdatabase -uwordpress -pwordpress wordpress

<% function wpVolumes() { %>
        - ./config/wp-config-defaults.php:/wp/config/wp-config-defaults.php
        - ./config:/wp/config
        - ./log:/wp/log
<% if ( wordpress.mode == 'image' ) { %>
        - type: volume
          source: wordpress
          target: /wp
          volume:
            nocopy: true
<% } else { %>
        - <%= wordpress.dir %>:/wp
<% } %>
<% if ( muPlugins.mode == 'image' ) { %>
        - type: volume
          source: mu-plugins
          target: /wp/wp-content/mu-plugins
          volume:
            nocopy: true
<% } else { %>
        - <%= muPlugins.dir %>:/wp/wp-content/mu-plugins
<% } %>
<% if ( jetpack.mode == 'image' ) { %>
        - type: volume
          source: jetpack
          target: /wp/wp-content/mu-plugins/jetpack
          volume:
            nocopy: true
<% } else if ( jetpack.mode == 'local' ) { %>
        - <%= jetpack.dir %>:/wp/wp-content/mu-plugins/jetpack
<% } %>
<% if ( clientCode.mode == 'image' ) { %>
        - type: volume
          source: clientcode_clientmuPlugins
          target: /wp/wp-content/client-mu-plugins
          volume:
            nocopy: true
        - type: volume
          source: clientcode_images
          target: /wp/wp-content/images
          volume:
            nocopy: true
        - type: volume
          source: clientcode_languages
          target: /wp/wp-content/languages
          volume:
            nocopy: true
        - type: volume
          source: clientcode_plugins
          target: /wp/wp-content/plugins
          volume:
            nocopy: true
        - type: volume
          source: clientcode_private
          # FIXME: Do we need this to be out of /wp for local development?
          target: /wp/wp-content/private
          volume:
            nocopy: true
        - type: volume
          source: clientcode_themes
          target: /wp/wp-content/themes
          volume:
            nocopy: true
        - type: volume
          source: clientcode_vipconfig
          target: /wp/wp-content/vip-config
          volume:
            nocopy: true
<% } else { %>
        - <%= clientCode.dir %>/client-mu-plugins:/wp/wp-content/client-mu-plugins
        - <%= clientCode.dir %>/images:/wp/wp-content/images
        - <%= clientCode.dir %>/languages:/wp/wp-content/languages
        - <%= clientCode.dir %>/plugins:/wp/wp-content/plugins
        - <%= clientCode.dir %>/private:/wp/wp-content/private
        - <%= clientCode.dir %>/themes:/wp/wp-content/themes
        - <%= clientCode.dir %>/vip-config:/wp/wp-content/vip-config
<% } %>
<% } %>
